---
title: "Prep_TrackingDataWrangling"
author: "Pauliina Vuorinen"
date: "18/03/2022"
output: html_document
---

## Introduction

The purpose of this script is to clean the raw reading behaviour tracking data for our analysis.

## Setup

Load libraries, set working directory

```{r, setup}
library(psych)
library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
getwd()
```

## Load data and check variable types

Load raw data from Data -folder and change variable types. See documents in Info -folder for information on different tracking events.

```{r, load data}
# load data
raw_tracking_data <-
    read.csv("Data_RawData.csv", header = TRUE, sep = ";", dec = ",")

# change variable types
str(raw_tracking_data)
rename(raw_tracking_data, StoryId = BookId)
source("Functions/Functions_VariableTypeConversion.R")

## turn user and story indicators into factors
raw_tracking_data[, c(
    "UserId",
    "StoryId"
)] <- convert.magic(raw_tracking_data[, c(
    "UserId",
    "StoryId"
)])
## turn reading block number (page view) into an ordered variable
raw_tracking_data$ReadingBlockNumber <-
    as.ordered(raw_tracking_data$ReadingBlockNumber)
```

## Exclusion criteria

Sixty-two participants were recruited to take part in the study. Two of the participants did not finish the study, and so they are excluded from the sample. The final *n* = 60.

```{r, exclusion}
raw_tracking_data <- filter(
    raw_tracking_data,
    (UserId != "33") &
        (UserId != "61")
)
```


## Missing and erroneous data values

Fix unrealistic and misleading data values in the tracking data. These errors arise from accidental miscoding in the collection of the tracking data, or alternative data formatting.

In the below code:
1. Change navigation block numbers (continuous navigation in one direction) recorded as zero into NA values. A navigation block number is only recorded as zero if the participant is not navigating the document. This is misleading, and so zeros are turned to NAs.
2. Similarly to navigation block numbers, reading block numbers (page views) are recorded as zero when the participant is not viewing a page. This is misleading, and so zeros are turned to NAs.
3. Inactive timeout events are erroneously coded as 'engagements' in the raw data. The inactive timeout indicates that the page view has been masked due to > 5mins of inactivity, and therefore, these event types should be coded as 'disengagements'.


```{r, erroneous values}
# point (1) above
raw_tracking_data[, "NavigationBlockNumber"][raw_tracking_data[, "NavigationBlockNumber"] == 0] <- NA

# point (2) above
raw_tracking_data[, "ReadingBlockNumber"][raw_tracking_data[, "ReadingBlockNumber"] == 0] <- NA

# point (3) above
raw_tracking_data[raw_tracking_data$Type == "inactiveTimeout", ]$Engagement <- "Disengagement"
# FIX: inactiveTimeout has wrong naming convention
```

### Adjustments to event and navigation durations

Event durations are important not only because they can tell us about how long an event lasted, but 'DurationMinutes' is also used to create cumulative durations (such as 'EngagementDuration'). The event durations are calculated by deducting an event's start time from the following event's start time. Therefore, the durations of events in the middle and the beginning of a reading session are accurate as long as all events are present in the tracking data. The last event in a reading session, however, has an excessive duration because duration is miscalculated by comparing the event to the next one that is in a new reading session. This excessive duration is adjusted in two different ways, depending on whether the event is categorised as a 'disengagement' or an 'engagement'.

```{r, find the last event in reading session}
raw_tracking_data$IsLastEventInReadingSession <- (
    (raw_tracking_data$ReadingSessionNumber !=
        lead(raw_tracking_data$ReadingSessionNumber, 1)) |
        (raw_tracking_data$UserId !=
            lead(raw_tracking_data$UserId, 1))
)
table(
    raw_tracking_data$Engagement,
    raw_tracking_data$IsLastEventInReadingSession
)
```

**Disengagements.** If the last event in a reading session is a disengagement, such as 'close' or 'logout' (see event types in info folder, document ___), the duration should be recorded as 0. A disengagement at the end of a reading session indicates of the participants' intention to leave the e-reader system, and so it's duration is arbitrary.

**Engagements.** Engagements that have a duration of >5min indicate of a missing tracking event. A reading session ending in an 'engagement' indicates that the final disengagement event (triggered by the closure of the e-reader system, for example, event of type 'logout') is missing. Similarly, an engagement event that has a duration of >5min in the middle of a reading session is indicative of a missing event: the e-reader system automatically masks the text after 5 minutes of inactivity (event type 'blur'), if an engagement event lasts for longer than 5 minutes, the text mask event may have not been recorded in the tracking data.

Missing events occur when the system doesn't have the time to record an event, for example when the e-reader system is abruptly closed or when network connection fails*. Indeed, correctly recorded engagements should last for a maximum of 5 minutes before the e-reader system masks the text. Therefore, excessive engagement durations are checked by filtering the dataset for engagements that last for longer than 5.1 minutes.

**Note: the e-reader system works on the client side, but no temporary data storage is implemented to store events collected during network connection issues and so these events are lost in case of network connection failures.*

```{r, find excessive engagement durations}

excessive_engagement_durations_subdata <- filter(
    raw_tracking_data,
    (Engagement == "Engagement") &
        (DurationMinutes > 5.1)
)

table(excessive_engagement_durations_subdata$IsLastEventInReadingSession)
# 7 excessive engagement durations: X in the middle of session, Y at the end
```

The raw data is not edited, but instead the excessive durations are adjusted by creating new variables. 

* 'AdjustedEventDuration' shows the suggested new event duration
* 'AdjustedNavigationBlockDuration' shows the suggested adjustment to NavigationBlockDuration


```{r, adjustments to excessive durations}
raw_tracking_data$AdjustedEventDuration <- ifelse(
    ((raw_tracking_data$Engagement == "Engagement") &
        raw_tracking_data$DurationMinutes > 5.1),
    5,
    ifelse(
        ((raw_tracking_data$IsLastEventInReadingSession &
            raw_tracking_data$Engagement != "Engagement")),
        0
    )
)

raw_tracking_data$AdjustedNavigationBlockDuration <- ifelse(
    raw_tracking_data$AdjustedEventDuration != NA &
        raw_tracking_data$Engagement == "Engagement",
    (raw_tracking_data$NavigationBlockDuration - (raw_tracking_data$DurationMinutes - 5)),
    ifelse(
        raw_tracking_data$AdjustedEventDuration != NA &
            raw_tracking_data$Engagement != "Engagement",
        (raw_tracking_data$NavigationBlockDuration - raw_tracking_data$DurationMinutes)
    )
)
```
