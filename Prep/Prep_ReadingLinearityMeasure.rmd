---
title: "Prep_LinearityMeasure"
author: "Pauliina Vuorinen"
date: "19/04/2022-"
output: html_document
library: "S1_code_library.bib"
---

## Introduction and Definition of Nonlinearity

The purpose of this script is to compute a measure of linearity during reading of the short story. 

Linear navigation was defined as movement forwards in the text without skipping any pages. Nonlinear navigation, on the other hand, was defined as a regression or a forward leap according to the following:
* Regression: Any navigation backwards in the text, either by turning the pages or by using the progress bar.
* Forward leap: A jump forwards in the text with the progress bar to a section further than the next page, or turning of more than one page in a row at a browsing speed.

Browsing was used in the definition of nonlinearity because the intention behind browsing is to move between locations in the text rather than read. Browsing speed was defined as less than 1s used on a page-view.

To measure frequency of nonlinear navigation, we calculate how often a linear navigation event is followed by nonlinear navigation. This measure therefore reflects the frequency of initiating nonlinear navigation during reading of the story.

This script uses a dataframe that was wrangled in Prep_TrackingDataWrangling.Rmd.

## Setup

```{r, setup}
library(psych)
library(tidyverse)
library(tidyr)
library(dplyr)
getwd() # working directory should be ~/Short_Story_Reading_Behaviour_Public
```

## Load data and check variable types

```{r, load data}
# load data
wrangled_tracking_data <-
    read.csv(
        "Data/wrangled_tracking_data.csv",
        header = TRUE,
        sep = ";",
        dec = ","
    )

# change variable types
str(wrangled_tracking_data)
source("Functions/Functions_VariableTypeConversion.R")

## turn user and story indicators into factors
wrangled_tracking_data[, c(
    "UserId",
    "StoryId"
)] <- convert.magic(
    wrangled_tracking_data[, c(
        "UserId",
        "StoryId"
    )],
    "factor"
)
## turn reading block number (page view) into an ordered variable
wrangled_tracking_data$ReadingBlockNumber <-
    as.ordered(
        wrangled_tracking_data$ReadingBlockNumber
    )
## fix date and time variable types
wrangled_tracking_data$Time <-
    substr(
        wrangled_tracking_data$Time, 11, 23
    )
wrangled_tracking_data$Date <-
    as.Date(
        wrangled_tracking_data$Date,
        format = "%Y-%m-%d"
    )
op <-
    options(digits.secs = 3)
wrangled_tracking_data$Time <-
    strptime(
        wrangled_tracking_data$Time,
        format = "%H:%M:%OS"
    )
# order the df by User, date, time and event id
wrangled_tracking_data <-
    wrangled_tracking_data[
        with(
            wrangled_tracking_data,
            order(UserId, Date, Time, Id)
        ),
    ]
```

## Dataframe of grouped navigation blocks

First, we determine whether each navigation event in the data refers to nonlinear or linear navigation. Participants can move in the text by using the progress bar to jump backwards, or forwards to a position that is further than the next page. When the participant uses a progress bar, the e-reader system registers an event of type 'progressBarJump' followed by an event of type 'openPage' in the new location. Therefore, the linearity of progress bar navigation can be assessed by comparing the location of the event of type 'progressBarJump' and the location of the next event ('openPage'). Nonlinear navigation by page turns is more complex, however, because consecutive navigation events need to be grouped together. This type of nonlinearity is represented in the data by multiple page turns: a forward leap by page turns, for example, requires that the user turns more than one page forwards in a row at a browsing speed - and this is shown in the data by multiple page turn and 'openPage' pairs. To determine whether each event includes nonlinear or linear navigation, consecutive events that describe one navigation sequence need to be grouped together.

In the preprocessed data, navigation blocks are used to indicate if consecutive events should be grouped together or not. Consecutive events have the same navigation block number if they are reflective of nonlinear navigation to the same direction, at roughly the same reading speed (the 'openPage' events have the same speed labels, see information on speed labels in ___). Navigation events (such as page turn or a 'progressBarJump') are always part of the same navigation block as the following 'openPage' event - simply put, this reflects that when a user turns a page on the e-reader, a new page opens. If an event that occurs after a navigation event and an 'openPage' event pair indicates of another page turn in the same direction and at the same speed, then this navigation event and 'openPage' event are also given the same navigation block number. If the following event is not a navigation event or the navigation is not used to move at the same direction at similar speed, then navigation block number = previous navigation block number + 1.

Similarly to page turns, progress bar navigation is grouped together with the following 'openPage' event. However, multiple, consecutive occurrences of progress bar navigation are not grouped within the same navigation block.

See more information about navigation blocks in ___.

Navigation blocks are grouped together based on the indicators ('NavigationBlockNumber') already present in the data. In addition to the grouping, we also extract important event information that is needed for analyses, such as the duration of each navigation block.

```{r, group navigation blocks}
# first create a new df
grouped_navigation_blocks_data <- wrangled_tracking_data[1, ]
namevector <-
    c(
        "FirstStartLocation",
        "LastStartLocation",
        "FirstVisibleCharacterCount",
        "LastVisibleCharacterCount",
        "FirstReadingBlock",
        "LastReadingBlock",
        "FirstPercentage",
        "LastPercentage",
        "FirstPage",
        "LastPage",
        "NavBlockEndLocation",
        "AverageReadingSpeed",
        "NavBlockStartDeadline",
        "NavBlockEndDeadline",
        "FirstCumReadingSessionTime",
        "LastCumReadingSessionTime",
        "AdjustedNavigationBlockDuration",
        "NavBlockSpeedLabel",
        "AnyProgressBarUsage"
    )
grouped_navigation_blocks_data[0, namevector] <- NA
grouped_navigation_blocks_data <- grouped_navigation_blocks_data[0, ]

# group navigation blocks into a new df
for (i in levels(wrangled_tracking_data$UserId)) {
    # subset of each user
    subset_user <- subset(
        x = wrangled_tracking_data,
        subset = UserId == i
    )
    subset_user$NavigationBlockNumber <-
        as.ordered(subset_user$NavigationBlockNumber)

    for (j in levels(subset_user$NavigationBlockNumber)) {
        # subset of each user's each navigation block
        subset_navigationblock <- subset(
            x = subset_user,
            subset = NavigationBlockNumber == j
        )
        temporary_df <-
            mutate(
                subset_navigationblock,
                FirstStartLocation =
                    subset_navigationblock[
                        1,
                        "StartLocation"
                    ],
                LastStartLocation =
                    subset_navigationblock[
                        nrow(subset_navigationblock),
                        "StartLocation"
                    ],
                FirstVisibleCharacterCount =
                    subset_navigationblock[
                        1,
                        "VisibleCharacterCount"
                    ],
                LastVisibleCharacterCount =
                    subset_navigationblock[
                        nrow(subset_navigationblock),
                        "VisibleCharacterCount"
                    ],
                FirstReadingBlock =
                    subset_navigationblock[
                        1,
                        "ReadingBlockNumber"
                    ],
                LastReadingBlock =
                    subset_navigationblock[
                        nrow(subset_navigationblock),
                        "ReadingBlockNumber"
                    ],
                FirstPercentage =
                    subset_navigationblock[
                        1, "Percentage"
                    ],
                LastPercentage =
                    subset_navigationblock[
                        nrow(subset_navigationblock),
                        "Percentage"
                    ],
                FirstPage =
                    subset_navigationblock[1, "PageInSection"],
                LastPage =
                    subset_navigationblock[
                        nrow(subset_navigationblock),
                        "PageInSection"
                    ],
                NavBlockEndLocation =
                    LastStartLocation + LastVisibleCharacterCount,
                AverageReadingSpeed =
                    mean(EngagedReadingSpeed),
                NavBlockStartDeadline =
                    subset_navigationblock[
                        1,
                        "TimeBeforeDeadlinesDays"
                    ],
                NavBlockEndDeadline =
                    subset_navigationblock[
                        nrow(subset_navigationblock),
                        "TimeBeforeDeadlinesDays"
                    ],
                FirstCumReadingSessionTime =
                    subset_navigationblock[
                        1,
                        "CumReadingSessionTime"
                    ],
                LastCumReadingSessionTime =
                    subset_navigationblock[
                        nrow(subset_navigationblock),
                        "CumReadingSessionTime"
                    ],
                AdjustedNavigationBlockDuration =
                    min(AdjustedNavigationBlockDuration),
                NavBlockSpeedLabel =
                    subset_navigationblock[
                        nrow(subset_navigationblock),
                        "EngagedSpeedLabel"
                    ],
                AnyProgressBarUsage =
                    any
                    (
                        subset_navigationblock$Type == "progressBarJump"
                    )
            )
        grouped_navigation_blocks_data <-
            rbind(grouped_navigation_blocks_data, temporary_df[1, ])
    }
}
```

## Determine linearity

Next we determine how much the participants' location shifts in between different navigation blocks. This essentially tells us how much, and to what direction, the participant moved in the text (if at all).

To count the number of pages turned, we first create variables that check whether consecutive navigation blocks (one per row) should be compared. We only want to compare navigation blocks from
a) the same user
b) the same reading session and
c) the same reading set up (see below).

A reading set up affects the amount of 'pages' that the short story has, for example, in a small browser window the story is organised in more 'pages' than in a large browser window. Pages turned should only be determined between events that have the same reading set up. Note that this does not limit our ability to notice linearity of navigation as changing the reading set up will either result in an event that is in its own navigation block (which can then be compared to a subsequent navigation block; this happens e.g. when the participant resizes a browser window), or a change in reading set up starts a new reading session (e.g. when the participant changes device).

The page-wise data already includes variables for IsNewUser, IsNewSession, and IsReadingSetUpChange. These variables are first created and then re-created for grouped navigation blocks.

```{r, create tests}
grouped_navigation_blocks_data <- grouped_navigation_blocks_data %>%
    select(
        -IsNewUser,
        -IsNewSession,
        -IsReadingSetUpChange
    )
grouped_navigation_blocks_data$IsNewUser <-
    (
        grouped_navigation_blocks_data$UserId !=
            (lag(grouped_navigation_blocks_data$UserId, 1))
    )
grouped_navigation_blocks_data$IsNewSession <-
    (
        grouped_navigation_blocks_data$ReadingSessionNumber !=
            (lag(grouped_navigation_blocks_data$ReadingSessionNumber, 1))
    )
grouped_navigation_blocks_data$IsReadingSetUpChange <-
    (
        grouped_navigation_blocks_data$TotalPagesInSection !=
            (lag(grouped_navigation_blocks_data$TotalPagesInSection, 1))
    )
```

We can then calculate the amount of 'pages' turned between navigation blocks. The variable is calculated by subtracting a navigation block's start location (in pages) from the next navigation block's start location. If the reading set up, user, or reading session changes between the two navigation blocks and the navigation block includes movement, 'PagesTurned' is instead calculated by comparing the first page in a navigation block to the last page in the same navigation block.

```{r, count pages turned}
# count the number of pages turned within a navigation block
grouped_navigation_blocks_data$PagesTurned <-
    ifelse(
        ( # following navigation block is from
            ## same user,
            ## same reading session, and
            ## same reading set up
            !lead(grouped_navigation_blocks_data$IsNewUser, 1) &
                !lead(grouped_navigation_blocks_data$IsNewSession, 1) &
                !lead(grouped_navigation_blocks_data$IsReadingSetUpChange, 1)
        ),
        (
            lead(grouped_navigation_blocks_data$FirstPage, 1) -
                grouped_navigation_blocks_data$FirstPage
        ),
        ifelse(
            ( # the navigation block includes movement but
                ## the navigation block following it has a
                ### different user,
                ### different reading session, or
                ### different readign set up
                grouped_navigation_blocks_data$FirstPage !=
                    grouped_navigation_blocks_data$LastPage
            ),
            (
                grouped_navigation_blocks_data$LastPage -
                    grouped_navigation_blocks_data$FirstPage
            ),
            0
        )
    )
# Check PagesTurned
## - regression, + forward leap or a chronological page turn, 0 not a navigation
table(
    sign(grouped_navigation_blocks_data$PagesTurned)
)
```

PagesTurned tells us the direction and extent of navigation. We use this information to assign each navigation event a label of 'Regression' or 'ForwardLeap'. Considering that regressions refer to any movement backwards in text, any navigation block with a negative value for PagesTurned can be labelled as a 'Regression' (PagesTurned < 0). Forward leaps include forward movement to a position further than the next page (PagesTurned > 1), either by turning pages at a browsing speed (NavigationBlockSpeedLabel == "Browsing") or by using the progress bar (Type == progressBarJump).

```{r, regression and forward leap label assignment}
grouped_navigation_blocks_data$IsRegression <-
(
  grouped_navigation_blocks_data$PagesTurned < 0
)
table(grouped_navigation_blocks_data$IsRegression)

grouped_navigation_blocks_data$IsForwardLeap <-
(
    ((grouped_navigation_blocks_data$PagesTurned > 1) &
     (grouped_navigation_blocks_data$NavBlockSpeedLabel == "Browsing")) |
    ((grouped_navigation_blocks_data$PagesTurned > 1) &
       (grouped_navigation_blocks_data$AnyProgressBarUsage))
)
table(grouped_navigation_blocks_data$IsForwardLeap)
```

The data includes 530 regressions and 72 forward leaps.

Our aim is to measure linearity on each page-view, and so we need to first merge grouped_navigation_blocks_data with wrangled_tracking_data:

```{r, merge navigation block data with wrangled data}
# columns selected from grouped_navigation_blocks_data:
## UserId, NavigationBlockNumber, ReadingSessionNumber
### IsRegression, IsForwardLeap
### FirstCumReadingSessionTime, LastCumReadingSessionTime, NavBlockSpeedLabel
wrangled_tracking_data <-
    merge(
        wrangled_tracking_data,
        grouped_navigation_blocks_data[, c(2:4, 66:68, 73:75)],
        by = c("UserId", "ReadingSessionNumber", "NavigationBlockNumber"),
        all.x = TRUE
    )
```

Create columns that summarise information on nonlinearity based on IsRegression and IsForwardLeap
- IsNonlinearNavigation tells us whether the event includes a regression or a forward leap
- Linearity tells us what is the linearity type of the event (regression, forward leap, or linear/nonnavigation)
- IsLinearToNonlinear tells us whether the event initiates nonlinear navigation following linear navigation. First event in a reading session can be TRUE for IsLinearToNonlinear if the first event includes nonlinear navigation.

```{r}
wrangled_tracking_data$IsNonlinearNavigation <-
    ifelse(
        wrangled_tracking_data$IsRegression |
        wrangled_tracking_data$IsForwardLeap,
        TRUE,
        FALSE
    )
wrangled_tracking_data$Linearity <-
    ifelse(
        wrangled_tracking_data$IsRegression,
        "Regression",
        ifelse(
            wrangled_tracking_data$IsForwardLeap,
            "ForwardLeap",
            "LinearOrNonNavigation"
        )
    )
## add movement from Linear to Nonlinear
### then remove !IsReading and only use one event per page-view
```



```{r, checks}
# make sure the df is correctly ordered
wrangled_tracking_data <-
    wrangled_tracking_data[
        with(
            wrangled_tracking_data,
            order(UserId, Date, Time, Id)
        ),
    ]

eachuserfirstevent <- wrangled_tracking_data %>%
    group_by(UserId, ReadingSessionNumber) %>%
    filter(IsReading) %>%
    summarise(
        first_event_type_from_user = first(Type),
        first_event_linearity_from_user = first(Linearity)
    )
```