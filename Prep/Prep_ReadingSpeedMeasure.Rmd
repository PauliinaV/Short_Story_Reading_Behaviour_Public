---
title: "Prep_ReadingSpeedMeasure"
author: "Pauliina Vuorinen"
date: "14/10/2022-20/12/2023"
output: html_document
library: "~/Extra/RPackages.bib"
---

## Introduction

The purpose of this script is to compute a measure of reading speed. 

Participants' reading speed was measured in words per minute by comparing the time they spent on a page-view to the amount of words on each page. Reading speeds were then categorised by comparing the speed to participants' result in a baseline reading speed test. We were interested in 'deep reading' speeds, which reflect a natural reading speed at which the text can be comprehended. These speeds were assumed to vary between 100wpm and 2.4*baseline speed (see more information in the manuscript).

To compare participants' variance in reading speed, we normalise reading speeds by dividing it by baseline speed result. This measure is called 'ReadingRate'.

**Information on hypotheses:**

H3a: Situational autonomous motivation is connected to baseline-level and slower reading speed when situational competence is low.

H3b: Contextual autonomous motivation is connected to baseline-level and slower reading speed when situational competence is low.

H3d: Task-relevant electronic reading experience (TR-EEXP) is connected to baseline-level and slower reading speed when situational competence is low.

This script uses a dataframe that was wrangled in Prep_TrackingDataWrangling.Rmd.

## Setup

```{r 'setup'}
library(tidyverse)
library(tidyr)
library(dplyr)
```

```{r 'configure-path'}
if (exists("ExternalAnalysisFilePath")) {
    # ExternalAnalysisFilePath: ~/Short_Story_Reading_Behaviour_Public/
    mypath_SSRB <- ExternalAnalysisFilePath
} else if (grepl("Prep", getwd())) {
    mypath_SSRB <- dirname(getwd())
} else if (grepl("Short_Story_Reading_Behaviour_Public", getwd())) {
    mypath_SSRB <- getwd()
} else {
    # get working directory manually
    mypath_SSRB <- paste0(
            dirname(getwd()),
            "/Short_Story_Reading_Behaviour_Public"
        )
}
```

## Load data and check variable types

```{r 'load-data'}
tracking_data <-
    read.csv(
        paste0(
            mypath_SSRB,
            "/Data/wrangled_tracking_data.csv"
        ),
        header = TRUE,
        sep = ";",
        dec = ","
    )
tracking_data <- select(tracking_data, -X)
```

```{r 'change-variable-types'}
str(tracking_data)
source(
    paste0(
        mypath_SSRB,
        "/Functions/Functions_VariableTypeConversion.R"
    )
)

## turn columns into factors that should be factors
tracking_data[, c(
    "UserId",
    "StoryId",
    "Direction",
    "NavigationBlockDirection"
)] <- convert.magic(
    tracking_data[, c(
        "UserId",
        "StoryId",
        "Direction",
        "NavigationBlockDirection"
    )],
    "factor"
)
## fix numeric columns that were automatically categorised as character
tracking_data[, c(
    "BaselineSpeed",
    "DurationMinutes",
    "ReadingBlockDuration",
    "EngagedReadingDuration",
    "EngagedReadingSpeed",
    "NavigationBlockDuration",
    "TimeBeforeDeadlinesDays"
)] <- convert.magic(
    tracking_data[, c(
        "BaselineSpeed",
        "DurationMinutes",
        "ReadingBlockDuration",
        "EngagedReadingDuration",
        "EngagedReadingSpeed",
        "NavigationBlockDuration",
        "TimeBeforeDeadlinesDays"
    )],
    "numeric"
)
## turn reading block (page view) number,
### reading session number, and
#### navigation block number into ordered factors
tracking_data[, c(
    "ReadingBlockNumber",
    "ReadingSessionNumber",
    "NavigationBlockNumber"
)] <- convert.magic(
    tracking_data[, c(
        "ReadingBlockNumber",
        "ReadingSessionNumber",
        "NavigationBlockNumber"
    )],
    "ordered"
)
## fix logical variables
tracking_data[, c(
    "IsBlurred",
    "IsDialogOpen",
    "IsMenuOpen",
    "IsInactive",
    "IsReading",
    "IsPageOpen"
)] <- convert.magic(
    tracking_data[, c(
        "IsBlurred",
        "IsDialogOpen",
        "IsMenuOpen",
        "IsInactive",
        "IsReading",
        "IsPageOpen"
    )],
    "logical"
)

## fix date and time variable types
tracking_data$Date <-
    as.Date(
        tracking_data$Date,
        format = "%Y-%m-%d"
    )
TempTimeObject <- strsplit(tracking_data$Time, " ")
TempTimeObject <- sapply(TempTimeObject, '[[', 2)
tracking_data$TempTimeObject <- TempTimeObject
tracking_data <- dplyr::select(tracking_data, -Time)
names(tracking_data)[which(colnames(tracking_data) == "TempTimeObject")] <- "Time"
tracking_data$DateTime <- paste(
    tracking_data$Date,
    tracking_data$Time
)
op <-
    options(digits.secs = 3)
tracking_data$Time <-
    strptime(
        tracking_data$Time,
        format = "%H:%M:%OS"
    )
tracking_data <- tracking_data %>%
    mutate(DateTime = as.POSIXct(DateTime, format = "%Y-%m-%d %H:%M:%OS"))
```

## Reading speed measure

First, we remove all events that do not occur on a page-view:

```{r}
## 8144 rows (full data 8774 rows)
speed_measure_data <- tracking_data %>%
    filter(
        Engagement != "Disengagement" &
            Engagement != "Dialog"
    )
```

The dataset decreases from `r nrow(tracking_data)` rows to `r nrow(speed_measure_data)` rows.

Participants' reading speed is highly variant due to some very fast reading speeds during scanning and browsing of the text:

```{r}
ggplot(speed_measure_data, aes(x = UserId, y = EngagedReadingSpeed)) +
    geom_boxplot()
```

We then create a new column that includes participants' baseline speed if it is not adjusted, and adjusted baseline speed if adjustments were needed (see manuscript for more information on why baseline speed was adjusted):

```{r}
speed_measure_data$AdjustedBaselineSpeed <- ifelse(
    !(is.na(speed_measure_data$AdjustedBaselineSpeed)),
    speed_measure_data$AdjustedBaselineSpeed,
    speed_measure_data$BaselineSpeed
)
```

We then calculate difference in reading speed and baseline:

```{r}
speed_measure_data$ReadingSpeedDifference <- (
    speed_measure_data$EngagedReadingSpeed
    - speed_measure_data$AdjustedBaselineSpeed)
speed_measure_data$AbsReadingSpeedDifference <- abs(
    speed_measure_data$ReadingSpeedDifference
    )
```

Calculate reading rate (speed/baseline):

```{r}
speed_measure_data$ReadingRate <- (
    speed_measure_data$EngagedReadingSpeed
    / speed_measure_data$AdjustedBaselineSpeed
)
```

Calculate difference in reading speed relative to baseline ((speed - baseline)/baseline):

```{r}
speed_measure_data$RelativeSpeedDifference <- (
    speed_measure_data$ReadingSpeedDifference
    / speed_measure_data$AdjustedBaselineSpeed
)
speed_measure_data$AbsRelativeSpeedDifference <- abs(
    speed_measure_data$RelativeSpeedDifference
)
```

Finally, we select one observation per page-view to make sure that the dataset does not contain dublicate values:

```{r}
# make sure the df is correctly ordered
speed_measure_data <-
    speed_measure_data[
        with(
            speed_measure_data,
            order(UserId, Date, Time, Id)
        ),
    ]
# Select one event per each page-view:
## group events
### and summarise important variables into columns
speed_measure_data_alt <- speed_measure_data %>%
    filter(!(is.na(ReadingRate))) %>%
    group_by(
        UserId,
        StoryId,
        AdjustedBaselineSpeed,
        ReadingSessionNumber,
        ReadingBlockNumber, # used to identify each page-view
        Condition,
        ReadingSpeedDifference,
        AbsReadingSpeedDifference,
        RelativeSpeedDifference,
        AbsRelativeSpeedDifference,
        ReadingRate,
        EngagedSpeedLabel) %>%
    summarise(
        StartLocation = first(StartLocation),
        EndLocation = first(EndLocation),
        FirstTimeUntilDeadlineDays = first(TimeBeforeDeadlinesDays),
        FirstCumulativeRSTime = first(CumulativeRSTime),
        WindowWidth = first(WindowWidth)
    )
```

Overall, average reading speed across all page-views was `r round(mean(speed_measure_data_alt$ReadingSpeedDifference + speed_measure_data_alt$AdjustedBaselineSpeed), 2)`wpm. This value is high due to the very fast reading speeds during scanning and browsing.

How many pages were read in each speed category:

```{r}
speed_measure_data_dur <- speed_measure_data %>%
    filter(!(is.na(ReadingRate))) %>%
    group_by(
        UserId,
        StoryId,
        ReadingSessionNumber,
        ReadingBlockNumber, # used to identify each page-view
        Condition,
        ReadingSpeedDifference,
        AbsReadingSpeedDifference,
        RelativeSpeedDifference,
        AbsRelativeSpeedDifference,
        ReadingRate,
        EngagedSpeedLabel) %>%
    summarise(
        SummedDuration = sum(DurationMinutes),
        StartLocation = first(StartLocation),
        EndLocation = first(EndLocation),
        FirstTimeUntilDeadlineDays = first(TimeBeforeDeadlinesDays),
        FirstCumulativeRSTime = first(CumulativeRSTime),
        WindowWidth = first(WindowWidth)
    )
summarised_speed_time <- speed_measure_data_dur %>%
    group_by(UserId, EngagedSpeedLabel) %>%
    summarise(
        TimeAtSpeed = sum(SummedDuration)
    )
participant_time_on_page <- speed_measure_data_dur %>%
    group_by(UserId) %>%
    summarise(
        TotalEngagementTime = sum(SummedDuration)
    )
summarised_speed_time <- merge(summarised_speed_time, participant_time_on_page, by = "UserId")
summarised_speed_time <- summarised_speed_time %>%
    mutate(
        ProportionOfTime = (TimeAtSpeed/TotalEngagementTime)
    )
```

on average, participants spent `r mean(participant_time_on_page$TotalEngagementTime)` engaged in reading the text on the e-reader system. Of this time, they spent `r round(mean(summarised_speed_time[summarised_speed_time$EngagedSpeedLabel == "DeepReading", "ProportionOfTime"])*100, 2)`% deep reading the text,  `r round(mean(summarised_speed_time[summarised_speed_time$EngagedSpeedLabel == "SlowReading", "ProportionOfTime"])*100, 2)`% of the time reading it slower than 100wpm, and `r round((mean(summarised_speed_time[summarised_speed_time$EngagedSpeedLabel == "Skimming", "ProportionOfTime"]) + mean(summarised_speed_time[summarised_speed_time$EngagedSpeedLabel == "Scanning", "ProportionOfTime"]) + mean(summarised_speed_time[summarised_speed_time$EngagedSpeedLabel == "Browsing", "ProportionOfTime"]))*100, 2)`% of the time reading faster than 2.4* their baseline reading speed test result.

Only information on 'deep reading' speeds is retained in the measure dataset:

```{r}
reading_speed_measure_data <- filter(
    speed_measure_data_alt,
    EngagedSpeedLabel == "DeepReading"
)
```

The dataset decreases from `r nrow(speed_measure_data)` rows to `r nrow(reading_speed_measure_data)` rows. The average deep reading speed in the sample is `r round(mean(reading_speed_measure_data$ReadingSpeedDifference + reading_speed_measure_data$AdjustedBaselineSpeed), 2)`wpm.

## Inspect reading speed

```{r}
ggplot(reading_speed_measure_data, aes(x = UserId, y = ReadingRate)) +
    geom_boxplot() +
    theme_classic()
```

Some participants vary in their reading rate much more than others.

```{r}
ggplot(reading_speed_measure_data, aes(x = StartLocation, y = ReadingRate)) +
    geom_line() +
    geom_hline(yintercept = 1) +
    facet_wrap(~UserId)
```
Variance across different locations in the book (note that location is not standardised across the different texts).

We then inspect relative speed difference ((speed-baseline)/baseline):

```{r}
ggplot(reading_speed_measure_data, aes(x = UserId, y = RelativeSpeedDifference)) +
    geom_boxplot() +
    theme_classic()
```

```{r}
ggplot(reading_speed_measure_data, aes(x = StartLocation, y = RelativeSpeedDifference)) +
    geom_line() +
    geom_hline(yintercept = 0) +
    facet_wrap(~UserId)
```

## Save reading speed dataset

The new df is saved for usage in analysis.
The dataset has already been saved, and so the below sr code chunk is not run.

```{r, eval=FALSE, echo=TRUE}
# write.csv2(
#     reading_speed_measure_data,
#     "reading_speed_measure_data.csv"
# )
```